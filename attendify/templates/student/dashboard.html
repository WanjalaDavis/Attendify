{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendify | Student Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="icon" href="{% static 'images/attendify_logo.png' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-cog"></i>
                    <h3>Profile Settings</h3>
                </div>
                <button class="modal-close" id="closeProfileModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="profileForm" method="POST" enctype="multipart/form-data" action="{% url 'profile_edit' %}">
                    {% csrf_token %}
                    <div class="form-sections">
                        <!-- Personal Information Section -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-user"></i>
                                <h4>Personal Information</h4>
                            </div>
                            
                            <div class="profile-image-section">
                                <div class="current-avatar">
                                    <img id="profilePreview" src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ user.first_name }}&background=4f46e5&color=fff&bold=true{% endif %}" alt="Profile Picture">
                                </div>
                                <div class="avatar-controls">
                                    <label for="id_profile_picture" class="btn-secondary">
                                        <i class="fas fa-upload"></i>
                                        Upload Image
                                    </label>
                                    <input type="file" id="id_profile_picture" name="profile_picture" accept="image/*" style="display: none;">
                                    <p class="file-info">PNG, JPG up to 5MB</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_first_name">First Name</label>
                                <input type="text" id="id_first_name" name="first_name" value="{{ user.first_name }}" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="id_last_name">Last Name</label>
                                <input type="text" id="id_last_name" name="last_name" value="{{ user.last_name }}" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="id_email">Email Address</label>
                                <input type="email" id="id_email" name="email" value="{{ user.email }}" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="id_phone_number">Phone Number</label>
                                <input type="tel" id="id_phone_number" name="phone_number" value="{{ user.phone_number }}" class="form-input">
                            </div>
                        </div>
                        
                        <!-- Account Security Section -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Account Security</h4>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_username">Username</label>
                                <input type="text" id="id_username" name="username" value="{{ user.username }}" class="form-input" readonly>
                                <small class="field-note">Username cannot be changed</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_old_password">Current Password</label>
                                <input type="password" id="id_old_password" name="old_password" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="id_new_password1">New Password</label>
                                <input type="password" id="id_new_password1" name="new_password1" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="id_new_password2">Confirm New Password</label>
                                <input type="password" id="id_new_password2" name="new_password2" class="form-input">
                            </div>
                            
                            <div class="password-strength">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="passwordStrength"></div>
                                </div>
                                <span class="strength-text" id="passwordText">Password Strength</span>
                            </div>
                        </div>
                        
                        <!-- Read-only Information Section -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-graduation-cap"></i>
                                <h4>Academic Information</h4>
                            </div>
                            
                            <div class="read-only-info">
                                <div class="info-item">
                                    <span class="info-label">Registration Number</span>
                                    <span class="info-value">{{ student.registration_number }}</span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">Year of Study</span>
                                    <span class="info-value">{{ student.get_year_of_study_display }}</span>
                                </div>
                                
                                {% if student.enrollments.exists %}
                                    {% with enrollment=student.enrollments.first %}
                                        <div class="info-item">
                                            <span class="info-label">Course</span>
                                            <span class="info-value">{{ enrollment.course.name }}</span>
                                        </div>
                                        
                                        <div class="info-item">
                                            <span class="info-label">Enrollment Date</span>
                                            <span class="info-value">{{ student.enrollment_date|date:"M d, Y" }}</span>
                                        </div>
                                    {% endwith %}
                                {% endif %}
                                
                                <div class="info-item">
                                    <span class="info-label">Account Status</span>
                                    <span class="info-value status-active">
                                        <i class="fas fa-check-circle"></i>
                                        Active
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancelProfile">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Professional Header -->
    <header class="dashboard-header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="brand-section">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="brand-text">
                            <h1 class="brand-name">Attendify</h1>
                            <span class="brand-subtitle">Dashboard</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value">Mark</div>
                        <div class="stat-label">Attendance</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-value">1</div>
                        <div class="stat-label">Course</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-value">15</div>
                        <div class="stat-label">Streak</div>
                    </div>
                </div>
                
                <div class="user-section">
                    <div class="user-avatar" id="openProfileModal">
                        <img src="https://ui-avatars.com/api/?name={{ user.first_name }}&background=4f46e5&color=fff&bold=true" alt="{{ user.last_name }}">
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                        <div class="user-id">{{ student.registration_number }}</div>
                    </div>
                    <div class="header-actions">
                        <a href="{% url 'student_portal' %}" class="action-btn">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <a href="{% url 'logout' %}" class="action-btn logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Content -->
    <main class="dashboard-main">
        <div class="container-fluid">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h2>Welcome back, {{ user.first_name }}</h2>
                    <p>Ready to manage your academic attendance and progress</p>
                    <div class="welcome-meta">
                        <span class="meta-item">
                            <i class="fas fa-clock"></i>
                            Last login: {{ request.user.last_login|date:"M d, Y H:i" }}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-shield-alt"></i>
                            All systems operational
                        </span>
                    </div>
                </div>
                <div class="welcome-visual">
                    <div class="status-card">
                        <div class="status-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div class="status-text">
                            <span>QR System</span>
                            <small>Active & Ready</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Dashboard Modules -->
            <section class="modules-section">
                <div class="section-header">
                    <h3>Dashboard Modules</h3>
                    <p>Access your academic tools and features</p>
                </div>
                
                <div class="modules-grid">
                    <!-- QR Module -->
                    <div class="module-card">
                        <div class="module-icon qr">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div class="module-content">
                            <h4>QR Attendance</h4>
                            <p>Mark attendance using encrypted QR codes with real-time validation</p>
                            <div class="module-stats">
                                <div class="stat">
                                    <span>Speed</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 95%"></div>
                                    </div>
                                </div>
                                <div class="stat">
                                    <span>Accuracy</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 98%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="module-actions">
                            <a href="{% url 'student_portal' %}" class="btn-primary">
                                Access Portal
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Analytics Module -->
                    <div class="module-card">
                        <div class="module-icon analytics">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="module-content">
                            <h4>Analytics Dashboard</h4>
                            <p>Track your attendance patterns and academic performance</p>
                            <div class="data-visual">
                                <div class="visual-bar" style="height: 80%"></div>
                                <div class="visual-bar" style="height: 95%"></div>
                                <div class="visual-bar" style="height: 65%"></div>
                                <div class="visual-bar" style="height: 90%"></div>
                                <div class="visual-bar" style="height: 75%"></div>
                            </div>
                        </div>
                        <div class="module-actions">
                            <a href="{% url 'student_portal' %}" class="btn-primary">
                                View Analytics
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Courses Module -->
                    <div class="module-card">
                        <div class="module-icon courses">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="module-content">
                            <h4>Course Management</h4>
                            {% if student.enrollments.exists %}
                                {% with enrollment=student.enrollments.first %}
                                    <p>Your course <strong>{{ enrollment.course.name }}</strong> with {{ enrolled_units }} active units</p>
                                    <div class="course-tags">
                                        <span class="tag">{{ enrolled_units }} Units</span>
                                        <span class="tag">Active</span>
                                        <span class="tag">Enrolled</span>
                                    </div>
                                {% endwith %}
                            {% else %}
                                <p>You are not currently enrolled in any course</p>
                                <div class="course-tags">
                                    <span class="tag">No enrollment</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="module-actions">
                            <a href="{% url 'student_portal' %}" class="btn-primary">
                                Browse Courses
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Profile Module -->
                    <div class="module-card">
                        <div class="module-icon profile">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <div class="module-content">
                            <h4>Profile System</h4>
                            <p>Manage your personal information and account settings</p>
                            <div class="security-status">
                                <i class="fas fa-shield-check"></i>
                                <span>Security Level: Maximum</span>
                            </div>
                        </div>
                        <div class="module-actions">
                            <a href="#" class="btn-primary" id="profileModuleLink">
                                Configure Profile
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Activity Feed -->
            <section class="activity-section">
                <div class="activity-container">
                    <div class="activity-header">
                        <h3>Recent Activity</h3>
                        <div class="activity-controls">
                            <span class="online-indicator">
                                <i class="fas fa-circle"></i> Live
                            </span>
                        </div>
                    </div>
                    
                    <div class="activity-feed">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="activity-content">
                                <p>User {{ user.username }} authenticated successfully</p>
                                <span class="activity-time">{{ now|date:"H:i:s" }}</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-qrcode"></i>
                            </div>
                            <div class="activity-content">
                                <p>QR scanner system initialized and ready</p>
                                <span class="activity-time">{{ now|date:"H:i:s" }}</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="activity-content">
                                <p>All security protocols active and running</p>
                                <span class="activity-time">{{ now|date:"H:i:s" }}</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="activity-content">
                                <p>Database connection established - courses loaded</p>
                                <span class="activity-time">{{ now|date:"H:i:s" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h3>Quick Actions</h3>
                    <p>Frequently used features and tools</p>
                </div>
                
                <div class="actions-grid">
                    <a href="{% url 'student_portal' %}" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="action-content">
                            <h5>Scan QR Code</h5>
                            <p>Mark your attendance quickly</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'student_portal' %}" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="action-content">
                            <h5>View Schedule</h5>
                            <p>Check your class timetable</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'student_portal' %}" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="action-content">
                            <h5>View Analytics</h5>
                            <p>Track your attendance stats</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    
                    <a href="#" class="action-card" id="profileActionButton">
                        <div class="action-icon">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <div class="action-content">
                            <h5>Profile Settings</h5>
                            <p>Manage your account</p>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="dashboard-footer">
        <div class="container-fluid">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="logo-container small">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="brand-text">
                            <h3 class="brand-name">Attendify</h3>
                            <span class="brand-subtitle">Student Dashboard</span>
                        </div>
                    </div>
                    <p>Advanced attendance management system</p>
                </div>
                
                <div class="footer-links">
                    <div class="link-group">
                        <h4>System</h4>
                        <a href="{% url 'student_portal' %}">Student Portal</a>
                        <a href="#" id="footerProfileLink">Profile</a>
                        <a href="#">Documentation</a>
                    </div>
                    
                    <div class="link-group">
                        <h4>Support</h4>
                        <a href="#">Help Center</a>
                        <a href="#">Status</a>
                        <a href="#">Contact</a>
                    </div>
                </div>
                
                <div class="footer-status">
                    <div class="status-indicator">
                        <i class="fas fa-server"></i>
                        <span>All Systems Operational</span>
                    </div>
                    <div class="uptime">99.9% Uptime</div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Attendify Systems | Version 2.0.1</p>
                <div class="tech-info">
                    <span>Powered by: Django • WebSocket • AES-256</span>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
    
    <script>
        // Profile Modal Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const profileModal = document.getElementById('profileModal');
            const openProfileModal = document.getElementById('openProfileModal');
            const profileModuleLink = document.getElementById('profileModuleLink');
            const profileActionButton = document.getElementById('profileActionButton');
            const footerProfileLink = document.getElementById('footerProfileLink');
            const closeProfileModal = document.getElementById('closeProfileModal');
            const cancelProfile = document.getElementById('cancelProfile');
            
            // Open modal from various elements
            [openProfileModal, profileModuleLink, profileActionButton, footerProfileLink].forEach(element => {
                if (element) {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        profileModal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    });
                }
            });
            
            // Close modal
            [closeProfileModal, cancelProfile].forEach(element => {
                if (element) {
                    element.addEventListener('click', function() {
                        profileModal.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    });
                }
            });
            
            // Close modal when clicking outside content
            profileModal.addEventListener('click', function(e) {
                if (e.target === profileModal) {
                    profileModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
            
            // Profile picture preview
            const profilePictureInput = document.getElementById('id_profile_picture');
            const profilePreview = document.getElementById('profilePreview');
            
            if (profilePictureInput && profilePreview) {
                profilePictureInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            profilePreview.src = e.target.result;
                        }
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Password strength indicator
            const passwordInput1 = document.getElementById('id_new_password1');
            const passwordStrength = document.getElementById('passwordStrength');
            const passwordText = document.getElementById('passwordText');
            
            if (passwordInput1 && passwordStrength && passwordText) {
                passwordInput1.addEventListener('input', function() {
                    const password = this.value;
                    let strength = 0;
                    let text = 'Weak';
                    let color = '#ef4444';
                    
                    if (password.length >= 8) strength += 25;
                    if (/[A-Z]/.test(password)) strength += 25;
                    if (/[0-9]/.test(password)) strength += 25;
                    if (/[^A-Za-z0-9]/.test(password)) strength += 25;
                    
                    if (strength >= 75) {
                        text = 'Strong';
                        color = '#10b981';
                    } else if (strength >= 50) {
                        text = 'Medium';
                        color = '#f59e0b';
                    }
                    
                    passwordStrength.style.width = strength + '%';
                    passwordStrength.style.backgroundColor = color;
                    passwordText.textContent = text;
                    passwordText.style.color = color;
                });
            }
        });
    </script>
</body>
</html>