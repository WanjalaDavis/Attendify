{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Attendify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="icon" href="{% static 'images/attendify_logo.png' %}">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/student.css' %}">
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="logo-text">Attendify</div>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <ul class="sidebar-nav">
            <li class="nav-item active">
                <a href="{% url 'student_dashboard' %}" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>My Schedule</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <i class="fas fa-book"></i>
                    <span>Units</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="settingsLink">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">
                    {{ student.user.first_name|first }}{{ student.user.last_name|first }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ student.user.get_full_name }}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <h1 class="page-title">Student Dashboard</h1>
                <div class="breadcrumb">
                    <span>Home</span> / <span>Dashboard</span>
                </div>
            </div>
            <div class="header-right">
                <div class="header-actions">
                    <button class="header-btn" id="notificationsBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                    <button class="header-btn" id="quickScanBtn">
                        <i class="fas fa-qrcode"></i>
                        Quick Scan
                    </button>
                    <div class="current-time" id="currentTime">
                        <i class="fas fa-clock"></i>
                        <span id="timeDisplay">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <section class="stats-overview">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ attendance_percentage }}%</h3>
                    <p class="stat-label">Overall Attendance</p>
                    <div class="stat-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        5.2% this month
                    </div>
                </div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ present_count }}</h3>
                    <p class="stat-label">Classes Attended</p>
                    <div class="stat-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        3 this week
                    </div>
                </div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ upcoming_classes_count }}</h3>
                    <p class="stat-label">Upcoming Classes</p>
                    <div class="stat-trend">
                        Next: Today 2:00 PM
                    </div>
                </div>
            </div>
            
            <div class="stat-card danger">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ absent_count }}</h3>
                    <p class="stat-label">Absences</p>
                    <div class="stat-trend negative">
                        <i class="fas fa-arrow-down"></i>
                        2 this month
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="dashboard-column">
                <!-- Quick Attendance Card -->
                <div class="card quick-attendance">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-fingerprint"></i>
                            Mark Attendance
                        </h2>
                        <div class="card-actions">
                            <button class="action-btn" id="refreshClasses">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="class-selector-container">
                        <select class="class-selector" id="classSelector">
                            <option value="" disabled selected>Select ongoing class</option>
                            {% for class in ongoing_classes %}
                                <option value="{{ class.id }}" data-lat="{{ class.latitude|default:0 }}" data-lng="{{ class.longitude|default:0 }}">
                                    {{ class.semester_unit.unit.code }} - {{ class.semester_unit.unit.name }} ({{ class.start_time }} - {{ class.end_time }})
                                </option>
                            {% empty %}
                                <option value="" disabled>No ongoing classes</option>
                            {% endfor %}
                        </select>
                        <div class="selector-icon">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    
                    <div class="attendance-methods">
                        <div class="method-tabs">
                            <div class="method-tab active" data-method="scan">
                                <div class="tab-icon">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <span>QR Scan</span>
                            </div>
                            <div class="method-tab" data-method="manual">
                                <div class="tab-icon">
                                    <i class="fas fa-keyboard"></i>
                                </div>
                                <span>Manual Code</span>
                            </div>
                            <div class="method-tab" data-method="location">
                                <div class="tab-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <span>Location</span>
                            </div>
                        </div>
                        
                        <div class="method-content active" id="scan-method">
                            <div class="qr-scanner-container">
                                <div id="my-qr-reader" class="qr-reader"></div>
                                <div class="scanner-instructions">
                                    <p><i class="fas fa-info-circle"></i> Position QR code within frame to scan automatically</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="method-content" id="manual-method">
                            <div class="input-group">
                                <label class="input-label">Enter Attendance Token</label>
                                <input type="text" class="input-field" id="tokenInput" placeholder="e.g., MATH101-5A2B9C-X7Y3Z">
                            </div>
                            <button class="btn btn-primary btn-block" id="submit-token">
                                <i class="fas fa-check-circle"></i> Submit Token
                            </button>
                        </div>
                        
                        <div class="method-content" id="location-method">
                            <div class="location-info">
                                <div class="location-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <h4>Location-based Attendance</h4>
                                <p>Automatically mark attendance when you're near the classroom</p>
                                <button class="btn btn-outline" id="enableLocation">
                                    <i class="fas fa-location-arrow"></i> Enable Location
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-calendar-day"></i>
                            Today's Schedule
                        </h2>
                        <span class="card-badge">{{ todays_classes|length }} classes</span>
                    </div>
                    <div class="schedule-list">
                        {% for class in todays_classes %}
                        <div class="schedule-item {% if class.is_ongoing_display %}ongoing{% endif %}" data-class-id="{{ class.id }}">
                            <div class="schedule-time">
                                <div class="time-start">{{ class.start_time }}</div>
                                <div class="time-end">{{ class.end_time }}</div>
                            </div>
                            <div class="schedule-details">
                                <h4 class="class-name">{{ class.semester_unit.unit.code }}</h4>
                                <p class="class-title">{{ class.semester_unit.unit.name }}</p>
                                <div class="class-meta">
                                    <span class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        {{ class.venue }}
                                    </span>
                                    <span class="meta-item">
                                        <i class="fas fa-user-tie"></i>
                                        {% if class.lecturer %}
                                            Dr. {{ class.lecturer.user.last_name }}
                                        {% else %}
                                            Lecturer not assigned
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="schedule-status">
                                <div class="attendance-status status-{{ class.attendance_status|lower }}">
                                    {% if class.attendance_marked %}
                                        {{ class.attendance_status }}
                                    {% else %}
                                        {{ class.display_status|upper }}
                                    {% endif %}
                                </div>
                                {% if class.is_ongoing_display %}
                                <div class="live-indicator">
                                    <span class="pulse-dot"></span>
                                    LIVE
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>No classes scheduled for today</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="dashboard-column">
                <!-- Analytics Charts -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            Attendance Analytics
                        </h2>
                        <div class="chart-controls">
                            <select class="chart-period" id="chartPeriod">
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="semester">This Semester</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>

                <!-- Attendance Distribution -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            Attendance Distribution
                        </h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="attendancePieChart"></canvas>
                    </div>
                    <div class="pie-legend" id="pieLegend"></div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            Recent Activity
                        </h2>
                    </div>
                    <div class="activity-feed">
                        {% for attendance in recent_attendances %}
                        <div class="activity-item">
                            <div class="activity-icon status-{{ attendance.status|lower }}">
                                <i class="fas fa-{% if attendance.status == 'PRESENT' %}check{% else %}times{% endif %}-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">
                                    Marked {{ attendance.status }} for {{ attendance.class_schedule.semester_unit.unit.code }}
                                </div>
                                <div class="activity-meta">
                                    <i class="far fa-clock"></i>
                                    {{ attendance.scan_time|time }} â€¢ {{ attendance.class_schedule.schedule_date }}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No recent activity</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Enrolled Units Section -->
        <section class="units-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-book"></i>
                    Enrolled Units ({{ unit_enrollments|length }})
                </h2>
                <button class="btn btn-outline" id="viewAllUnits">
                    View All Units
                </button>
            </div>
            
            {% if unit_enrollments %}
            <div class="units-grid">
                {% for unit in unit_enrollments %}
                <div class="unit-card">
                    <div class="unit-header">
                        <div class="unit-badge">
                            <span class="unit-code">{{ unit.code }}</span>
                            <span class="unit-credits">{{ unit.credit_hours }} Credits</span>
                        </div>
                        <div class="unit-actions">
                            <button class="icon-btn" title="View Details">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="unit-name">{{ unit.name }}</h3>
                    
                    <div class="unit-details">
                        <div class="unit-detail">
                            <i class="fas fa-user-tie"></i>
                            <span>{{ unit.lecturer_name }}</span>
                        </div>
                        <div class="unit-detail">
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{ unit.semester }}</span>
                        </div>
                        <div class="unit-detail">
                            <i class="fas fa-users"></i>
                            <span>{{ unit.enrolled_students_count }} students enrolled</span>
                        </div>
                    </div>
                    
                    <div class="unit-progress">
                        <div class="progress-header">
                            <span>Attendance</span>
                            <span class="progress-percentage">{{ unit.attendance_percentage|floatformat:1 }}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ unit.attendance_percentage }}%"></div>
                        </div>
                        <div class="progress-stats">
                            <span>{{ unit.present_classes }} of {{ unit.total_classes }} classes</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <p>No units enrolled for current semester</p>
                <a href="#" class="btn btn-primary">Enroll in Units</a>
            </div>
            {% endif %}
        </section>

        <!-- Upcoming Classes Section -->
        <section class="units-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-calendar-week"></i>
                    Upcoming Classes (Next 7 Days)
                </h2>
            </div>
            
            {% if upcoming_classes %}
            <div class="classes-list">
                {% for class in upcoming_classes %}
                <div class="class-card">
                    <div class="class-date">
                        <div class="date-day">{{ class.schedule_date|date:"D" }}</div>
                        <div class="date-number">{{ class.schedule_date|date:"d" }}</div>
                        <div class="date-month">{{ class.schedule_date|date:"M" }}</div>
                    </div>
                    <div class="class-details">
                        <h4 class="class-name">{{ class.semester_unit.unit.code }} - {{ class.semester_unit.unit.name }}</h4>
                        <div class="class-time">
                            <i class="fas fa-clock"></i>
                            {{ class.start_time }} - {{ class.end_time }}
                        </div>
                        <div class="class-location">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ class.venue }}
                        </div>
                        <div class="class-lecturer">
                            <i class="fas fa-user-tie"></i>
                            {% if class.lecturer %}
                                Dr. {{ class.lecturer.user.get_full_name }}
                            {% else %}
                                Lecturer not assigned
                            {% endif %}
                        </div>
                    </div>
                    <div class="class-actions">
                        <button class="btn btn-outline btn-sm">Add to Calendar</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No upcoming classes in the next 7 days</p>
            </div>
            {% endif %}
        </section>
    </main>

    <!-- Profile Settings Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal profile-modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Profile Settings</h3>
                <button class="close-modal" id="closeProfileModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="profileForm" method="POST" action="{% url 'profile_edit' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Profile Picture Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-camera"></i>
                            Profile Picture
                        </h4>
                        <div class="profile-picture-section">
                            <div class="current-avatar">
                                {% if student.user.profile_picture %}
                                    <img src="{{ student.user.profile_picture.url }}" alt="Profile Picture" class="profile-avatar">
                                {% else %}
                                    <div class="profile-avatar-placeholder">
                                        {{ student.user.first_name|first }}{{ student.user.last_name|first }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="avatar-upload">
                                <label class="file-upload-btn">
                                    <i class="fas fa-upload"></i>
                                    Upload New Photo
                                    <input type="file" name="profile_picture" accept="image/*" class="file-input">
                                </label>
                                <small class="file-hint">JPG, PNG or GIF. Max 5MB.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-user"></i>
                            Personal Information
                        </h4>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">First Name *</label>
                                <input type="text" 
                                       name="first_name" 
                                       class="input-field" 
                                       value="{{ student.user.first_name }}"
                                       required>
                                {% if user_form.first_name.errors %}
                                <div class="error-message">
                                    {{ user_form.first_name.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Last Name *</label>
                                <input type="text" 
                                       name="last_name" 
                                       class="input-field" 
                                       value="{{ student.user.last_name }}"
                                       required>
                                {% if user_form.last_name.errors %}
                                <div class="error-message">
                                    {{ user_form.last_name.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Email Address *</label>
                                <input type="email" 
                                       name="email" 
                                       class="input-field" 
                                       value="{{ student.user.email }}"
                                       required>
                                {% if user_form.email.errors %}
                                <div class="error-message">
                                    {{ user_form.email.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Phone Number</label>
                                <input type="tel" 
                                       name="phone_number" 
                                       class="input-field" 
                                       value="{{ student.user.phone_number|default:'' }}"
                                       placeholder="+254 XXX XXX XXX">
                                {% if user_form.phone_number.errors %}
                                <div class="error-message">
                                    {{ user_form.phone_number.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Student Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-graduation-cap"></i>
                            Student Information
                        </h4>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Registration Number</label>
                                <input type="text" 
                                       class="input-field" 
                                       value="{{ student.registration_number }}"
                                       disabled
                                       style="background-color: #f8f9fa;">
                                <small class="field-hint">Registration number cannot be changed</small>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Course</label>
                                <input type="text" 
                                       class="input-field" 
                                       value="{{ student.course.name|default:'Not assigned' }}"
                                       disabled
                                       style="background-color: #f8f9fa;">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Department</label>
                                <input type="text" 
                                       class="input-field" 
                                       value="{{ student.department.name|default:'Not assigned' }}"
                                       disabled
                                       style="background-color: #f8f9fa;">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Year of Study</label>
                                <select name="year_of_study" class="input-field">
                                    <option value="1" {% if student.year_of_study == 1 %}selected{% endif %}>Year 1</option>
                                    <option value="2" {% if student.year_of_study == 2 %}selected{% endif %}>Year 2</option>
                                    <option value="3" {% if student.year_of_study == 3 %}selected{% endif %}>Year 3</option>
                                    <option value="4" {% if student.year_of_study == 4 %}selected{% endif %}>Year 4</option>
                                    <option value="5" {% if student.year_of_study == 5 %}selected{% endif %}>Year 5</option>
                                </select>
                                {% if profile_form.year_of_study.errors %}
                                <div class="error-message">
                                    {{ profile_form.year_of_study.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-address-card"></i>
                            Contact Information
                        </h4>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Address</label>
                                <textarea name="address" 
                                          class="input-field" 
                                          rows="3" 
                                          placeholder="Enter your current address">{{ student.address|default:'' }}</textarea>
                                {% if profile_form.address.errors %}
                                <div class="error-message">
                                    {{ profile_form.address.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Emergency Contact</label>
                                <input type="text" 
                                       name="emergency_contact" 
                                       class="input-field" 
                                       value="{{ student.emergency_contact|default:'' }}"
                                       placeholder="Emergency contact person name">
                                {% if profile_form.emergency_contact.errors %}
                                <div class="error-message">
                                    {{ profile_form.emergency_contact.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Emergency Phone</label>
                                <input type="tel" 
                                       name="emergency_phone" 
                                       class="input-field" 
                                       value="{{ student.emergency_phone|default:'' }}"
                                       placeholder="Emergency contact phone number">
                                {% if profile_form.emergency_phone.errors %}
                                <div class="error-message">
                                    {{ profile_form.emergency_phone.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelProfile">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="saveProfile">
                            <i class="fas fa-save"></i>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal password-modal">
            <div class="modal-header">
                <h3><i class="fas fa-lock"></i> Change Password</h3>
                <button class="close-modal" id="closePasswordModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="passwordForm" method="POST" action="{% url 'change_password' %}">
                    {% csrf_token %}
                    
                    <div class="form-section">
                        <div class="input-group">
                            <label class="input-label">Current Password *</label>
                            <input type="password" 
                                   name="old_password" 
                                   class="input-field" 
                                   required
                                   placeholder="Enter your current password">
                            <div class="password-toggle">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">New Password *</label>
                            <input type="password" 
                                   name="new_password1" 
                                   class="input-field" 
                                   required
                                   placeholder="Enter new password">
                            <div class="password-toggle">
                                <i class="fas fa-eye"></i>
                            </div>
                            <small class="field-hint">
                                Password must contain at least 8 characters with letters and numbers.
                            </small>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Confirm New Password *</label>
                            <input type="password" 
                                   name="new_password2" 
                                   class="input-field" 
                                   required
                                   placeholder="Confirm new password">
                            <div class="password-toggle">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Password Requirements -->
                    <div class="password-requirements">
                        <h5>Password Requirements:</h5>
                        <ul>
                            <li class="requirement-item">
                                <i class="fas fa-check requirement-met"></i>
                                At least 8 characters long
                            </li>
                            <li class="requirement-item">
                                <i class="fas fa-check requirement-met"></i>
                                Contains both letters and numbers
                            </li>
                            <li class="requirement-item">
                                <i class="fas fa-check requirement-met"></i>
                                Not too similar to personal information
                            </li>
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelPassword">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="savePassword">
                            <i class="fas fa-key"></i>
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Menu Modal -->
    <div class="modal-overlay" id="settingsMenuModal">
        <div class="modal settings-menu-modal">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Settings</h3>
                <button class="close-modal" id="closeSettingsMenu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="settings-options">
                    <div class="settings-option" id="editProfileOption">
                        <div class="option-icon">
                            <i class="fas fa-user-edit"></i>
                        </div>
                        <div class="option-content">
                            <h4>Edit Profile</h4>
                            <p>Update your personal information and contact details</p>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-option" id="changePasswordOption">
                        <div class="option-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="option-content">
                            <h4>Change Password</h4>
                            <p>Update your account password for security</p>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-option">
                        <div class="option-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="option-content">
                            <h4>Notifications</h4>
                            <p>Manage your notification preferences</p>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-option">
                        <div class="option-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="option-content">
                            <h4>Appearance</h4>
                            <p>Change theme and display settings</p>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notification success" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content">
            <div class="notification-title">Success!</div>
            <div class="notification-message">Your attendance has been successfully marked!</div>
        </div>
        <button class="close-notification" id="closeNotification">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Quick Scan Modal -->
    <div class="modal-overlay" id="quickScanModal">
        <div class="modal quick-scan-modal">
            <div class="modal-header">
                <h3>Quick Attendance Scan</h3>
                <button class="close-modal" id="closeQuickScan">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="qr-scanner-container">
                    <div id="quick-qr-reader" class="qr-reader"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Token for AJAX requests -->
    <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

    <!-- URL CONFIGURATION - MUST BE BEFORE STUDENT.JS -->
    <script>
        // Global configuration for URLs - this makes Django template tags work in JavaScript
        window.APP_CONFIG = {
            urls: {
                scanQR: '{% url "scan_qr_code" %}',
                attendanceStats: '{% url "api_student_attendance_stats" %}',
                recentAttendance: '{% url "api_student_recent_attendance" %}',
                profileEdit: '{% url "profile_edit" %}',
                changePassword: '{% url "change_password" %}'
            },
            csrfToken: '{{ csrf_token }}'
        };
        
        // Debug: Check if URLs are loaded correctly
        console.log('APP_CONFIG loaded:', window.APP_CONFIG);
    </script>

    <!-- Load student.js AFTER the configuration -->
    <script src="{% static 'js/student.js' %}"></script>
    
    <!-- Profile Management Script -->
    <script>
        class ProfileManager {
            constructor() {
                this.initEventListeners();
            }

            initEventListeners() {
                // Settings menu
                document.getElementById('settingsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.openSettingsMenu();
                });

                // Profile editing
                document.getElementById('editProfileOption').addEventListener('click', () => {
                    this.openProfileModal();
                });

                // Password change
                document.getElementById('changePasswordOption').addEventListener('click', () => {
                    this.openPasswordModal();
                });

                // Close modals
                document.getElementById('closeProfileModal').addEventListener('click', () => this.closeProfileModal());
                document.getElementById('closePasswordModal').addEventListener('click', () => this.closePasswordModal());
                document.getElementById('closeSettingsMenu').addEventListener('click', () => this.closeSettingsMenu());

                // Cancel buttons
                document.getElementById('cancelProfile').addEventListener('click', () => this.closeProfileModal());
                document.getElementById('cancelPassword').addEventListener('click', () => this.closePasswordModal());

                // Password visibility toggle
                this.initPasswordToggles();

                // File upload preview
                this.initFileUpload();

                // Form submissions
                this.initFormSubmissions();
            }

            openSettingsMenu() {
                document.getElementById('settingsMenuModal').classList.add('active');
            }

            closeSettingsMenu() {
                document.getElementById('settingsMenuModal').classList.remove('active');
            }

            openProfileModal() {
                this.closeSettingsMenu();
                document.getElementById('profileModal').classList.add('active');
            }

            closeProfileModal() {
                document.getElementById('profileModal').classList.remove('active');
            }

            openPasswordModal() {
                this.closeSettingsMenu();
                document.getElementById('passwordModal').classList.add('active');
            }

            closePasswordModal() {
                document.getElementById('passwordModal').classList.remove('active');
            }

            initPasswordToggles() {
                const toggles = document.querySelectorAll('.password-toggle');
                toggles.forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        const input = e.target.closest('.input-group').querySelector('input');
                        const icon = e.target.closest('.password-toggle').querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            input.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    });
                });
            }

            initFileUpload() {
                const fileInput = document.querySelector('input[name="profile_picture"]');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Validate file size (5MB limit)
                            if (file.size > 5 * 1024 * 1024) {
                                this.showNotification('File size must be less than 5MB', 'error');
                                e.target.value = '';
                                return;
                            }

                            // Validate file type
                            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                            if (!validTypes.includes(file.type)) {
                                this.showNotification('Please select a valid image file (JPG, PNG, GIF)', 'error');
                                e.target.value = '';
                                return;
                            }

                            // Preview image
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const preview = document.querySelector('.current-avatar');
                                preview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview" class="profile-avatar">`;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            initFormSubmissions() {
                const profileForm = document.getElementById('profileForm');
                const passwordForm = document.getElementById('passwordForm');

                if (profileForm) {
                    profileForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = new FormData(profileForm);
                        const submitBtn = document.getElementById('saveProfile');
                        
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                        submitBtn.disabled = true;

                        try {
                            const response = await fetch(profileForm.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                }
                            });

                            if (response.ok) {
                                this.showNotification('Profile updated successfully!', 'success');
                                this.closeProfileModal();
                                // Reload to show updated data
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                const data = await response.json();
                                this.showNotification(data.message || 'Error updating profile', 'error');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            this.showNotification('Network error. Please try again.', 'error');
                        } finally {
                            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                            submitBtn.disabled = false;
                        }
                    });
                }

                if (passwordForm) {
                    passwordForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = new FormData(passwordForm);
                        const submitBtn = document.getElementById('savePassword');
                        
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
                        submitBtn.disabled = true;

                        try {
                            const response = await fetch(passwordForm.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': document.getElementById('csrfToken').value,
                                    'X-Requested-With': 'XMLHttpRequest',
                                }
                            });

                            if (response.ok) {
                                this.showNotification('Password changed successfully!', 'success');
                                this.closePasswordModal();
                                passwordForm.reset();
                            } else {
                                const data = await response.json();
                                this.showNotification(data.message || 'Error changing password', 'error');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            this.showNotification('Network error. Please try again.', 'error');
                        } finally {
                            submitBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
                            submitBtn.disabled = false;
                        }
                    });
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                if (!notification) return;
                
                const icon = notification.querySelector('i');
                const title = notification.querySelector('.notification-title');
                const messageEl = notification.querySelector('.notification-message');
                
                if (!icon || !title || !messageEl) return;
                
                notification.className = `notification ${type}`;
                title.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                messageEl.textContent = message;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle',
                    warning: 'fa-exclamation-triangle'
                };
                icon.className = `fas ${icons[type] || icons.info}`;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    this.hideNotification();
                }, 5000);
            }

            hideNotification() {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.classList.remove('show');
                }
            }
        }

        // Initialize profile manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ProfileManager();
        });

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>

    <!-- Units Data for Charts -->
    <script id="unitsData" type="application/json">
        {{ units_json|safe }}
    </script>

</body>
</html>