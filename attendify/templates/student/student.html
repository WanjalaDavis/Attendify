{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendify | Student Portal</title>
    <link rel="stylesheet" href="{% static 'css/student.css' %}">
    <link rel="icon" href="{% static 'images/attendify_logo.png' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    <!-- Professional Header -->
    <header class="portal-header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="brand-section">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="brand-text">
                            <h1 class="brand-name">Attendify</h1>
                            <span class="brand-subtitle">Student Portal</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ present_classes }}</div>
                        <div class="stat-label">Present</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-value">{{ enrolled_units }}</div>
                        <div class="stat-label">Units</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-value">{{ attendance_percentage }}%</div>
                        <div class="stat-label">Attendance</div>
                    </div>
                </div>
                
                <div class="user-section">
                    <div class="user-avatar">
                        <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&background=4f46e5&color=fff&bold=true" alt="{{ user.last_name }}">
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                        <div class="user-id">{{ student.registration_number }}</div>
                    </div>
                    <div class="header-actions">
                        <a href="{% url 'student_dashboard' %}" class="action-btn">
                            <i class="fas fa-home"></i>
                        </a>
                        <a href="{% url 'logout' %}" class="action-btn logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="portal-main">
        <div class="container-fluid">
            <div class="welcome-section">
                <div class="welcome-content">
                    <h2>Welcome back, {{ user.first_name }}</h2>
                    <p>You have {{ todays_classes.count }} classes today with {{ attendance_percentage }}% overall attendance</p>
                </div>
                <div class="welcome-visual">
                    <div class="visual-card">
                        <div class="visual-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="visual-text">
                            <span>Active Student</span>
                            <small>Portal Access Granted</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="navigation-tabs p-3">
                <div class="tabs-container">
                    <button class="nav-tab active" data-tab="classes">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Today's Classes</span>
                    </button>
                    <button class="nav-tab" data-tab="attendance">
                        <i class="fas fa-qrcode"></i>
                        <span>Attendance</span>
                    </button>
                    <button class="nav-tab" data-tab="units">
                        <i class="fas fa-book"></i>
                        <span>My Units</span>
                    </button>
                    <button class="nav-tab" data-tab="analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </button>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content active" id="classes-tab">
                <div class="content-grid">
                    <!-- Today's Classes -->
                    <div class="content-card full-width p-3">
                        <div class="card-header">
                            <h3>Today's Classes</h3>
                            <span class="card-badge">{{ todays_classes.count }} scheduled</span>
                        </div>
                        <div class="card-body">
                            <div id="todays-classes-container">
                                {% if todays_classes %}
                                    <div class="classes-list" id="todays-classes-list">
                                        {% for class in todays_classes %}
                                        <div class="class-card {% if class.is_ongoing %}ongoing{% else %}upcoming{% endif %}" 
                                             data-class-id="{{ class.id }}"
                                             data-start-time="{{ class.start_time|time:'H:i:s' }}"
                                             data-end-time="{{ class.end_time|time:'H:i:s' }}">
                                            <div class="class-status-indicator"></div>
                                            <div class="class-icon">
                                                <i class="fas fa-{% if class.is_ongoing %}play-circle{% else %}clock{% endif %}"></i>
                                            </div>
                                            <div class="class-details">
                                                <h4>{{ class.semester_unit.unit.name }}</h4>
                                                <p class="class-meta">{{ class.semester_unit.unit.code }} | {{ class.venue }}</p>
                                                <div class="class-info">
                                                    <span class="time">{{ class.start_time|time:"H:i" }} - {{ class.end_time|time:"H:i" }}</span>
                                                    <span class="lecturer">Dr. {{ class.lecturer.user.last_name }}</span>
                                                </div>
                                            </div>
                                            <div class="class-actions">
                                                {% if class.is_ongoing %}
                                                    <span class="status-badge live">Live</span>
                                                    <a href="#qr-scanner" class="btn-primary" onclick="showTab('attendance')">
                                                        Scan QR
                                                    </a>
                                                {% else %}
                                                    <span class="status-badge upcoming">Upcoming</span>
                                                    <div class="countdown-timer" id="countdown-{{ class.id }}"></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-calendar-times"></i>
                                        <h4>No classes scheduled for today</h4>
                                        <p>Enjoy your day off or check upcoming classes</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="content-card p-3">
                        <div class="card-header">
                            <h3>Quick Stats</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">{{ total_classes }}</div>
                                        <div class="stat-label">Total Classes</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">{{ present_classes }}</div>
                                        <div class="stat-label">Present</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">{{ attendance_percentage }}%</div>
                                        <div class="stat-label">Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Classes -->
                    <div class="content-card p-3">
                        <div class="card-header">
                            <h3>Upcoming Classes</h3>
                            <span class="card-badge">{{ upcoming_classes.count }} classes</span>
                        </div>
                        <div class="card-body">
                            {% if upcoming_classes %}
                                <div class="compact-list">
                                    {% for class in upcoming_classes|slice:":5" %}
                                    <div class="compact-item">
                                        <div class="item-main">
                                            <strong>{{ class.semester_unit.unit.code }}</strong>
                                            <span>{{ class.schedule_date|date:"D, M d" }}</span>
                                        </div>
                                        <div class="item-meta">
                                            {{ class.start_time|time:"H:i" }} | {{ class.venue }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state small">
                                    <i class="fas fa-wind"></i>
                                    <p>No upcoming classes</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Tab -->
            <div class="tab-content" id="attendance-tab">
                <div class="content-grid">
                    <!-- QR Scanner -->
                    <div class="content-card full-width p-3">
                        <div class="card-header">
                            <h3>QR Attendance System</h3>
                            <span class="card-badge">Secure</span>
                        </div>
                        <div class="card-body">
                            <div class="scanner-layout">
                                <div class="scanner-content">
                                    <h4>Real-time QR Scanning</h4>
                                    <p>Scan your lecturer's QR code to mark attendance automatically. System validates location and timing.</p>
                                    
                                    <!-- Ongoing Classes for QR Scanning -->
                                    <div class="ongoing-classes-section">
                                        <h5>Available for Scanning:</h5>
                                        <div id="ongoing-classes-list" class="ongoing-classes-list">
                                            <!-- Dynamic content will be loaded here -->
                                        </div>
                                    </div>

                                    <div class="scanner-interface" id="qr-scanner">
                                        <div class="scanner-frame">
                                            <div class="scanner-overlay">
                                                <div class="scanner-laser"></div>
                                            </div>
                                            <video id="qr-video" class="scanner-video" style="display: none;"></video>
                                            <canvas id="qr-canvas" class="scanner-canvas" style="display: none;"></canvas>
                                        </div>
                                        
                                        <div class="scanner-controls">
                                            <button class="btn-primary" id="start-scanner">
                                                <i class="fas fa-camera"></i>
                                                Start Camera Scan
                                            </button>
                                            <button class="btn-secondary" id="upload-qr">
                                                <i class="fas fa-upload"></i>
                                                Upload QR Image
                                            </button>
                                            <input type="file" id="qr-file-input" accept="image/*" style="display: none;">
                                        </div>
                                    </div>

                                    <!-- Manual QR Token Input -->
                                    <div class="manual-qr-input">
                                        <h4>Or Enter Token Manually</h4>
                                        <form id="qr-token-form">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <input 
                                                    type="text" 
                                                    id="qr-token-input" 
                                                    name="qr_token" 
                                                    class="form-input" 
                                                    placeholder="Enter QR Token" 
                                                    required
                                                    disabled
                                                >
                                                <div class="input-status" id="token-input-status">
                                                    <i class="fas fa-info-circle"></i>
                                                    <span>Select a class first</span>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn-success" id="submit-token-btn" disabled>
                                                <i class="fas fa-key"></i> Submit Token
                                            </button>
                                        </form>
                                        <div id="qr-token-status" class="status-indicator" style="margin-top:10px;"></div>
                                    </div>

                                    <div class="scanner-status" id="scanner-status">
                                        <div class="status-indicator">
                                            <i class="fas fa-circle"></i>
                                            <span>Select a class to begin scanning</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="scanner-sidebar">
                                    <h4>Scanning Protocol</h4>
                                    <div class="protocol-steps">
                                        <div class="protocol-step">
                                            <div class="step-number">1</div>
                                            <div class="step-content">
                                                <strong>Select Ongoing Class</strong>
                                                <p>Choose from available live classes</p>
                                            </div>
                                        </div>
                                        <div class="protocol-step">
                                            <div class="step-number">2</div>
                                            <div class="step-content">
                                                <strong>Position QR Code</strong>
                                                <p>Ensure QR code is clearly visible</p>
                                            </div>
                                        </div>
                                        <div class="protocol-step">
                                            <div class="step-number">3</div>
                                            <div class="step-content">
                                                <strong>Auto-Capture</strong>
                                                <p>System automatically detects and scans</p>
                                            </div>
                                        </div>
                                        <div class="protocol-step">
                                            <div class="step-number">4</div>
                                            <div class="step-content">
                                                <strong>Location Validation</strong>
                                                <p>GPS coordinates verified against class location</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="security-features">
                                        <h5>Security Features</h5>
                                        <div class="security-tags">
                                            <span class="security-tag">AES-256 Encryption</span>
                                            <span class="security-tag">Token Expiry</span>
                                            <span class="security-tag">GPS Validation</span>
                                            <span class="security-tag">Time Window</span>
                                        </div>
                                    </div>

                                    <!-- Selected Class Info -->
                                    <div class="selected-class-info" id="selected-class-info" style="display: none;">
                                        <h5>Selected Class:</h5>
                                        <div class="class-details">
                                            <div id="selected-class-name" class="class-name"></div>
                                            <div id="selected-class-time" class="class-time"></div>
                                            <div id="selected-class-venue" class="class-venue"></div>
                                            <div class="time-remaining" id="time-remaining">
                                                <i class="fas fa-clock"></i>
                                                <span id="remaining-time-text"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Attendance -->
                    <div class="content-card p-3">
                        <div class="card-header">
                            <h3>Recent Scans</h3>
                        </div>
                        <div class="card-body">
                            {% if attendances %}
                                <div class="attendance-history">
                                    {% for attendance in attendances|slice:":5" %}
                                    <div class="attendance-item {% if attendance.status == 'PRESENT' %}present{% elif attendance.status == 'LATE' %}late{% else %}absent{% endif %}">
                                        <div class="attendance-icon">
                                            <i class="fas fa-{% if attendance.status == 'PRESENT' %}check-circle{% elif attendance.status == 'LATE' %}clock{% else %}times-circle{% endif %}"></i>
                                        </div>
                                        <div class="attendance-info">
                                            <strong>{{ attendance.class_schedule.semester_unit.unit.code }}</strong>
                                            <span>{{ attendance.class_schedule.schedule_date|date:"M d" }}</span>
                                        </div>
                                        <div class="attendance-status">
                                            <span class="status-badge {{ attendance.status|lower }}">{{ attendance.status }}</span>
                                            {% if attendance.scan_time %}
                                                <small>{{ attendance.scan_time|time:"H:i" }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state small">
                                    <i class="fas fa-ban"></i>
                                    <p>No attendance records</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Units Tab -->
            <div class="tab-content" id="units-tab">
                <div class="content-grid">
                    <!-- My Units -->
                    <div class="content-card full-width p-3">
                        <div class="card-header">
                            <h3>Enrolled Units</h3>
                            <span class="card-badge">{{ unit_enrollments.count }} active</span>
                        </div>
                        <div class="card-body">
                            {% if unit_enrollments %}
                                <div class="units-grid">
                                    {% for enrollment in unit_enrollments %}
                                    <div class="unit-card">
                                        <div class="unit-header">
                                            <h4>{{ enrollment.semester_unit.unit.code }}</h4>
                                            <span class="unit-credits">{{ enrollment.semester_unit.unit.credit_hours }} credits</span>
                                        </div>
                                        <div class="unit-body">
                                            <h5>{{ enrollment.semester_unit.unit.name }}</h5>
                                            <div class="unit-meta">
                                                <div class="meta-item">
                                                    <i class="fas fa-user-tie"></i>
                                                    <span>Dr. {{ enrollment.semester_unit.lecturer.user.last_name }}</span>
                                                </div>
                                                <div class="meta-item">
                                                    <i class="fas fa-calendar"></i>
                                                    <span>{{ enrollment.semester_unit.semester.name }}</span>
                                                </div>
                                            </div>
                                            
                                            {% if unit_attendance and unit_attendance.unit_id == enrollment.semester_unit.unit.id %}
                                            <div class="unit-stats">
                                                <div class="unit-stat">
                                                    <span>Attendance</span>
                                                    <div class="progress-bar">
                                                        <div class="progress-fill" style="width: {{ unit_attendance.attendance_percentage }}%"></div>
                                                    </div>
                                                    <span>{{ unit_attendance.attendance_percentage }}%</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="unit-actions">
                                            <button class="btn-link view-attendance" data-unit-id="{{ enrollment.semester_unit.id }}">
                                                View Attendance
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-book"></i>
                                    <h4>No units enrolled</h4>
                                    <p>Contact your administrator for unit enrollment</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Unit Details (Dynamic) -->
                    <div class="content-card" id="unit-details-card" style="display: none;">
                        <div class="card-header">
                            <h3>Unit Analytics</h3>
                            <button class="btn-icon" onclick="hideUnitDetails()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="card-body" id="unit-details-content">
                            <!-- Dynamic content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-tab">
                <div class="content-grid">
                    <!-- Attendance Overview -->
                    <div class="content-card p-3">
                        <div class="card-header">
                            <h3>Attendance Overview</h3>
                        </div>
                        <div class="card-body">
                            <div class="analytics-main">
                                <div class="attendance-circle">
                                    <div class="circle-progress" data-percentage="{{ attendance_percentage }}">
                                        <div class="circle-inner">
                                            <span class="percentage">{{ attendance_percentage }}%</span>
                                            <span class="label">Overall</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="attendance-breakdown">
                                    <div class="breakdown-item">
                                        <span class="label">Present</span>
                                        <span class="value">{{ present_classes }}</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="label">Late</span>
                                        <span class="value">{{ attendances|length|add:"-present_classes" }}</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="label">Total</span>
                                        <span class="value">{{ total_classes }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Trends -->
                    <div class="content-card p-3">
                        <div class="card-header">
                            <h3>Weekly Trend</h3>
                        </div>
                        <div class="card-body">
                            <div class="trend-chart">
                                <div class="chart-bars">
                                    <div class="chart-bar-trend" style="height: 80%">
                                        <span class="bar-label">Mon</span>
                                    </div>
                                    <div class="chart-bar-trend" style="height: 95%">
                                        <span class="bar-label">Tue</span>
                                    </div>
                                    <div class="chart-bar-trend" style="height: 65%">
                                        <span class="bar-label">Wed</span>
                                    </div>
                                    <div class="chart-bar-trend" style="height: 90%">
                                        <span class="bar-label">Thu</span>
                                    </div>
                                    <div class="chart-bar-trend" style="height: {{ attendance_percentage }}%">
                                        <span class="bar-label">Fri</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="content-card full-width p-3">
                        <div class="card-header">
                            <h3>Attendance History</h3>
                        </div>
                        <div class="card-body">
                            <div class="attendance-table">
                                <div class="table-header">
                                    <div class="table-col">Date</div>
                                    <div class="table-col">Unit</div>
                                    <div class="table-col">Lecturer</div>
                                    <div class="table-col">Status</div>
                                    <div class="table-col">Time</div>
                                </div>
                                <div class="table-body">
                                   {% for attendance in attendances|slice:":10" %}
    <div class="table-row">
        <!-- Date (from scan_time) -->
        <div class="table-col">
            {% if attendance.scan_time %}
                {{ attendance.scan_time|date:"M d, Y" }}
            {% else %}
                -
            {% endif %}
        </div>

        <!-- Unit Code -->
        <div class="table-col">
            <strong>{{ attendance.class_schedule.semester_unit.unit.code }}</strong>
        </div>

        <!-- Lecturer -->
        <div class="table-col">
            Dr. {{ attendance.class_schedule.lecturer.user.last_name }}
        </div>

        <!-- Status -->
        <div class="table-col">
            <span class="status-indicator {{ attendance.status|lower }}">
                {{ attendance.status }}
            </span>
        </div>

        <!-- Time (from scan_time) -->
        <div class="table-col">
            {% if attendance.scan_time %}
                {{ attendance.scan_time|time:"H:i" }}
            {% else %}
                -
            {% endif %}
        </div>
    </div>
{% empty %}
    <div class="table-row empty">
        <div class="table-col" colspan="5">No attendance records found</div>
    </div>
{% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="portal-footer">
        <div class="container-fluid">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="logo-container small">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="brand-text">
                            <h3 class="brand-name">Attendify</h3>
                            <span class="brand-subtitle">Student Portal</span>
                        </div>
                    </div>
                    <p>Academic attendance management system</p>
                </div>
                
                <div class="footer-links">
                    <div class="link-group">
                        <h4>Portal</h4>
                        <a href="{% url 'student_dashboard' %}">Dashboard</a>
                        <a href="{% url 'student_portal' %}">Portal</a>
                        <a href="{% url 'profile' %}">Profile</a>
                    </div>
                    
                    <div class="link-group">
                        <h4>Support</h4>
                        <a href="#">Help Center</a>
                        <a href="#">System Status</a>
                        <a href="#">Contact Admin</a>
                    </div>
                </div>
                
                <div class="footer-status">
                    <div class="status-indicator">
                        <i class="fas fa-user-graduate"></i>
                        <span>Student Mode Active</span>
                    </div>
                    <div class="user-id">{{ student.registration_number }}</div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Attendify Systems | Student Portal v2.0.1</p>
                <div class="tech-info">
                    <span>Secure Connection • Real-time Data • Encrypted QR</span>
                </div>
            </div>
        </div>
    </footer>


<!-- Floating Background Elements -->
<div class="background-elements">
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
</div>


    <!-- QR Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="{% static 'js/student.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>    
    
</body>
</html>